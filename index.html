<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>çµçŠ€Â·ç½—å¡å¡” v2.2 - æ——èˆ°ç‰ˆ</title>
    <style>
        :root { --pink: #ff4d94; --cyan: #00f2ff; --bg: #07080a; --panel: rgba(20, 25, 35, 0.7); }
        body { margin: 0; background: var(--bg); color: #e0e0e0; font-family: "PingFang SC", sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* å¸ƒå±€æ§åˆ¶ */
        .left-radar { width: 35%; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.1); background: radial-gradient(circle at 50% 50%, #1a1c2c 0%, var(--bg) 100%); }
        .right-console { width: 65%; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; }

        /* çµçŠ€è§†è§‰åŒº */
        .avatar-zone { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; min-height: 400px; }
        .avatar-group { display: flex; flex-direction: column; align-items: center; transform: scale(0.9); position: relative; }
        .stat-badge { position: absolute; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; width: 140px; z-index: 20; }
        .stat-cn { font-size: 18px; font-weight: bold; margin-bottom: 2px; }
        .stat-en { width: 100%; font-size: 8px; color: #777; display: flex; justify-content: space-between; font-weight: bold; letter-spacing: 1px; }
        .stat-value { font-size: 24px; font-weight: bold; margin-top: 4px; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .stat-top { top: -80px; } .stat-top .stat-cn { color: var(--pink); letter-spacing: 4px; }
        .stat-bottom { bottom: -80px; } .stat-bottom .stat-cn { color: var(--cyan); letter-spacing: 2px; }
        .avatar-image { width: 220px; height: 320px; object-fit: contain; filter: drop-shadow(0 0 15px rgba(255, 77, 148, 0.2)); }

        /* æƒ…æŠ¥åŒº */
        .info-zone { padding: 20px; background: rgba(0,0,0,0.3); border-top: 1px solid #222; max-height: 250px; overflow-y: auto; }
        .section-label { font-size: 10px; color: var(--cyan); letter-spacing: 2px; margin-bottom: 10px; display: block; text-transform: uppercase; }
        .tag-input { width: 100%; background: #111; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 12px; box-sizing: border-box; outline: none; }
        .tag-input:focus { border-color: var(--cyan); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-item { background: rgba(0,242,255,0.1); border: 1px solid var(--cyan); color: var(--cyan); padding: 4px 10px; border-radius: 15px; font-size: 11px; }

        /* å³ä¾§æ“ä½œåŒº */
        .chat-area { width: 100%; height: 120px; background: #0c0d11; border: 1px solid #333; color: #fff; padding: 15px; border-radius: 12px; resize: none; font-size: 15px; box-sizing: border-box; line-height: 1.6; margin-bottom: 15px; }
        .controls { display: flex; gap: 15px; align-items: center; margin-bottom: 25px; }
        .btn-run { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 12px 35px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .btn-run:hover { background: var(--cyan); color: #000; box-shadow: 0 0 20px rgba(0,242,255,0.2); }
        select { background: #111; border: 1px solid #444; color: #ccc; padding: 10px; border-radius: 8px; outline: none; }

        /* ç»“æœå±•ç¤º */
        .output-flow { flex: 1; border-top: 1px solid #222; padding-top: 25px; }
        .card { background: var(--panel); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; margin-bottom: 20px; backdrop-filter: blur(10px); }
        .card-header { font-size: 11px; color: #666; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #333; padding-bottom: 8px; }
        .card-body { font-size: 15px; line-height: 1.7; color: #d0d0d0; }
        .option-pill { border-left: 3px solid var(--pink); background: rgba(255,77,148,0.05); padding: 15px; margin-top: 12px; border-radius: 0 8px 8px 0; }
        .option-tag { font-size: 10px; color: var(--pink); font-weight: bold; margin-bottom: 4px; display: block; }

        @media (max-aspect-ratio: 1/1) {
            body { flex-direction: column; overflow-y: auto; }
            .left-radar, .right-console { width: 100%; height: auto; }
            .left-radar { border-right: none; border-bottom: 1px solid #222; padding-bottom: 40px; }
        }
    </style>
</head>
<body>

    <div class="left-radar">
        <div class="avatar-zone">
            <div class="avatar-group">
                <div class="stat-badge stat-top">
                    <div class="stat-cn">å¥½æ„Ÿåº¦</div>
                    <div class="stat-en"><span>A</span><span>F</span><span>F</span><span>E</span><span>C</span><span>T</span><span>I</span><span>O</span><span>N</span></div>
                    <div class="stat-value" id="affDisplay">30%</div>
                </div>
                <img class="avatar-image" id="avatar" src="https://api.dicebear.com/7.x/notionists/svg?seed=Lily&backgroundColor=transparent" alt="Avatar">
                <div class="stat-badge stat-bottom">
                    <div class="stat-cn">çµé­‚è§£ç ç‡</div>
                    <div class="stat-en"><span>D</span><span>E</span><span>C</span><span>O</span><span>D</span><span>I</span><span>N</span><span>G</span></div>
                    <div class="stat-value" id="decDisplay">0%</div>
                </div>
            </div>
        </div>
        <div class="info-zone">
            <span class="section-label">LINGXI DATA / ç”»åƒæƒ…æŠ¥</span>
            <input type="text" class="tag-input" id="tagIn" placeholder="å½•å…¥æ€§æ ¼/å–œå¥½/æ ‡ç­¾(æŒ‰å›è½¦)..." onkeypress="addTag(event)">
            <div class="tag-list" id="tagList"></div>
        </div>
    </div>

    <div class="right-console">
        <div class="input-box">
            <span class="section-label">ROSETTA INTERFACE / èŠå¤©å†…å®¹åŠç›®çš„</span>
            <textarea id="chatInput" class="chat-area" placeholder="åœ¨æ­¤ç²˜è´´å¯¹æ–¹æœ€åä¸€æ®µå›å¤..."></textarea>
            <div class="controls">
                <select id="goalSelect">
                    <option value="å»ºç«‹èˆ’é€‚æ„Ÿ">å»ºç«‹èˆ’é€‚æ„Ÿ</option>
                    <option value="åˆ¶é€ å¼ åŠ›/æš§æ˜§">åˆ¶é€ å¼ åŠ›/æš§æ˜§</option>
                    <option value="å‘èµ·çº¿ä¸‹é‚€çº¦">å‘èµ·çº¿ä¸‹é‚€çº¦</option>
                    <option value="åŒ–è§£å†²çª/å°´å°¬">åŒ–è§£å†²çª/å°´å°¬</option>
                </select>
                <button class="btn-run" onclick="startAnalysis()">å¯åŠ¨ç½—å¡å¡”ç ´è¯‘</button>
            </div>
        </div>
        <div class="output-flow" id="output">
            <div style="text-align:center; color:#333; margin-top:50px">[ å¼•æ“å¾…æœºä¸­ ]</div>
        </div>
    </div>
    <script>
    // ...ä¹‹å‰çš„ä»£ç ä¿æŒä¸å˜...
    async function startAnalysis() {
        const chat = document.getElementById('chatInput').value;
        const goal = document.getElementById('goalSelect').value;
        const output = document.getElementById('output');
        if(!chat) return alert("è¯·è¾“å…¥å†…å®¹");

        output.innerHTML = `<div style="text-align:center; color:var(--cyan);">å¤§è„‘è¿æ¥ä¸­...</div>`;

        const fullPrompt = `ä½ ç°åœ¨æ˜¯ç¤¾äº¤å¼•æ“â€œç½—å¡å¡”â€ã€‚[ç”»åƒç¢ç‰‡]ï¼š${portraitTags.join(', ')} [å½“å‰å¯¹è¯]ï¼š${chat} [ç”¨æˆ·ç›®æ ‡]ï¼š${goal} è¯·åˆ†æå¹¶è¿”å›JSONã€‚`;

        try {
            const response = await fetch('/api/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: fullPrompt })
            });

            const data = await response.json();

            // å¦‚æœåç«¯ä¼ å›äº† Google çš„å…·ä½“é”™è¯¯
            if (data.googleError) {
              throw new Error("Google æ‹’ç»äº†è¯·æ±‚ï¼š" + data.googleError);
            }

            // æ­£å¸¸è§£æ
            const aiText = data.candidates[0].content.parts[0].text;
            const cleanJson = aiText.replace(/```json|```/g, '').trim();
            const result = JSON.parse(cleanJson);
            
            // ...æ›´æ–° UI çš„é€»è¾‘ (currentAff ç­‰)...
            output.innerHTML = `<div class="card">æ¨æ¼”ç»“æœï¼š${result.inference}</div>`; 

        } catch (err) {
            output.innerHTML = `<div style="color:red; font-size:12px; padding:20px;">
                ğŸš¨ ç ´è¯‘ä¸­æ–­ï¼<br>
                è¯¦ç»†åŸå› ï¼š${err.message}<br><br>
                ğŸ’¡ è§£å†³å»ºè®®ï¼š<br>
                1. æ£€æŸ¥ Vercel é‡Œçš„ API Key æ˜¯å¦æœ‰ç©ºæ ¼ã€‚<br>
                2. æ£€æŸ¥ Google AI Studio æ˜¯å¦ç»™äº†æƒé™ã€‚<br>
                3. ç¡®ä¿ä½ çš„â€œé­”æ³•â€ç½‘ç»œç¨³å®šã€‚
            </div>`;
        }
    }
</script>
</body>
</html>
