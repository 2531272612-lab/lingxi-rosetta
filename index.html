<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>灵犀·罗塞塔 v3.1 - 赛博核心</title>
    <style>
        :root {
            --pink: #ff2d78;
            --cyan: #00f7ff;
            --bg-dark: #0a0b12;
            --glass-bg: rgba(20, 25, 40, 0.6);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --text-primary: #e0e6ff;
            --text-secondary: #8a94b8;
        }
        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 247, 255, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(255, 45, 120, 0.1) 0%, transparent 40%);
            color: var(--text-primary);
            font-family: "PingFang SC", "Helvetica Neue", sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* 通用组件风格 */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
        }
        .section-label {
            font-size: 10px;
            color: var(--cyan);
            letter-spacing: 2px;
            margin-bottom: 12px;
            display: block;
            text-transform: uppercase;
            opacity: 0.8;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* 左侧雷达区 */
        .left-radar {
            width: 38%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255,255,255,0.05);
            background: linear-gradient(180deg, rgba(10,11,18,0.8) 0%, rgba(0,0,0,0.4) 100%);
        }
        .avatar-zone {
            flex: 3;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        /* 动态扫描光圈 */
        .avatar-zone::after {
            content: '';
            position: absolute;
            width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 50%, var(--bg-dark) 100%);
            z-index: 1;
        }
        .avatar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            transform: scale(0.95);
            z-index: 2;
        }
        .stat-badge {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            width: 160px;
        }
        .stat-cn { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .stat-en { font-size: 8px; color: var(--text-secondary); letter-spacing: 3px; }
        .stat-value {
            font-size: 28px;
            font-weight: 800;
            margin-top: 5px;
            text-shadow: 0 0 15px currentColor;
        }
        .stat-top { top: -90px; color: var(--pink); }
        .stat-bottom { bottom: -90px; color: var(--cyan); }
        
        .avatar-image {
            width: 240px; height: 340px;
            object-fit: contain;
            filter: drop-shadow(0 0 20px rgba(0, 247, 255, 0.15));
            transition: all 0.5s ease;
        }

        /* 情报录入区 */
        .info-zone {
            flex: 2;
            padding: 25px;
            background: rgba(0,0,0,0.2);
            border-top: var(--glass-border);
            display: flex; flex-direction: column;
        }
        .tag-input {
            width: 100%;
            background: rgba(255,255,255,0.05);
            border: none;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            color: #fff;
            padding: 12px 0;
            font-size: 14px;
            outline: none;
            transition: 0.3s;
        }
        .tag-input:focus { border-bottom-color: var(--cyan); }
        .tag-list { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; overflow-y: auto; }
        .tag-item {
            background: rgba(0, 247, 255, 0.08);
            border: 1px solid var(--cyan);
            color: var(--cyan);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            animation: fadeIn 0.3s ease;
            cursor: pointer;
            transition: 0.3s;
        }
        .tag-item:hover { background: rgba(0, 247, 255, 0.2); }

        /* 右侧控制台 */
        .right-console {
            width: 62%;
            display: flex;
            flex-direction: column;
            padding: 30px;
            overflow-y: auto;
        }
        .input-box { margin-bottom: 30px; }
        .chat-area {
            width: 100%; height: 120px;
            background: rgba(255,255,255,0.03);
            border: var(--glass-border);
            color: var(--text-primary);
            padding: 18px;
            border-radius: 12px;
            resize: none;
            font-size: 15px;
            line-height: 1.6;
            box-sizing: border-box;
            transition: 0.3s;
        }
        .chat-area:focus { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.2); outline: none; }
        
        .controls { display: flex; gap: 20px; align-items: center; margin-top: 20px; }
        select {
            background: var(--glass-bg);
            border: var(--glass-border);
            color: var(--text-primary);
            padding: 12px 20px;
            border-radius: 8px;
            outline: none;
            flex: 1;
            cursor: pointer;
        }
        .btn-run {
            background: transparent;
            border: 1px solid var(--cyan);
            color: var(--cyan);
            padding: 12px 40px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        .btn-run:hover {
            background: var(--cyan);
            color: #000;
            box-shadow: 0 0 25px rgba(0, 247, 255, 0.4);
        }

        /* 结果输出区 */
        .output-flow { flex: 1; }
        /* 结果卡片出现的动画 */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .result-card {
            animation: slideUpFade 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .card {
            background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card-header {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex; align-items: center;
        }
        .card-header::before { content:''; display:inline-block; width:8px; height:8px; background:currentColor; border-radius:50%; margin-right:8px; }
        .header-pink { color: var(--pink); }
        .header-cyan { color: var(--cyan); }
        
        .card-body { font-size: 16px; line-height: 1.8; color: #d8e1f0; }
        
        .option-pill {
            background: rgba(255, 45, 120, 0.06);
            border-left: 3px solid var(--pink);
            padding: 18px;
            margin-top: 15px;
            border-radius: 0 12px 12px 0;
            transition: 0.3s;
        }
        .option-pill:hover { background: rgba(255, 45, 120, 0.12); transform: translateX(5px); }
        .option-tag { font-size: 11px; color: var(--pink); font-weight: 700; margin-bottom: 6px; display: block; letter-spacing: 1px; }

        /* 移动端适配 */
        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .left-radar, .right-console { width: 100%; }
            .left-radar { height: auto; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); }
            .avatar-zone { min-height: 300px; padding: 40px 0; }
            .avatar-image { width: 180px; height: 260px; }
            .stat-badge { transform: scale(0.9) translateX(-55%); }
            .right-console { padding: 25px; }
        }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    </style>
</head>
<body>

    <div class="left-radar">
        <div class="avatar-zone">
            <div class="avatar-group">
                <div class="stat-badge stat-top">
                    <div class="stat-cn">好感度</div>
                    <div class="stat-en">AFFECTION RATE</div>
                    <div class="stat-value" id="affDisplay">30%</div>
                </div>
                <img class="avatar-image" id="avatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=Unknown&backgroundColor=transparent" alt="Avatar">
                <div class="stat-badge stat-bottom">
                    <div class="stat-cn">灵魂解码率</div>
                    <div class="stat-en">DECODING LEVEL</div>
                    <div class="stat-value" id="decDisplay">0%</div>
                </div>
            </div>
        </div>
        <div class="info-zone">
            <span class="section-label">Target Data // 目标画像情报</span>
            <input type="text" class="tag-input" id="tagIn" placeholder="> 输入标签按回车 (如: 女, 医生)..." onkeypress="addTag(event)">
            <div class="tag-list" id="tagList"></div>
        </div>
    </div>

    <div class="right-console">
        <div class="input-box">
            <span class="section-label">Rosetta Core // 对话破译控制台</span>
            <textarea id="chatInput" class="chat-area" placeholder="> 在此粘贴目标回复记录..."></textarea>
            <div class="controls">
                <select id="goalSelect">
                    <option value="建立舒适感">策略：建立舒适感 (Comfort)</option>
                    <option value="制造张力/暧昧">策略：制造张力 (Tension)</option>
                    <option value="发起线下邀约">策略：发起邀约 (Date invite)</option>
                    <option value="化解冲突/尴尬">策略：化解冲突 (Resolve)</option>
                </select>
                <button class="btn-run" onclick="startAnalysis()">启动罗塞塔破译 >></button>
            </div>
        </div>
        <div class="output-flow" id="output">
            <div style="text-align:center; color: var(--text-secondary); margin-top:80px; letter-spacing: 2px;">
                [ 等待指令输入... ]
            </div>
        </div>
    </div>

    <script>
        // --- 核心数据 ---
        let portraitTags = JSON.parse(localStorage.getItem('lingxi_tags')) || [];
        let currentAff = 30;

        // --- 初始化 ---
        window.onload = () => {
            renderTags();
            updateAvatarState(); // 启动时检查一次头像
        };

        // --- 交互逻辑 ---
        function addTag(e) {
            if (e.key === 'Enter' && e.target.value.trim()) {
                portraitTags.push(e.target.value.trim());
                localStorage.setItem('lingxi_tags', JSON.stringify(portraitTags));
                e.target.value = '';
                renderTags();
                updateAvatarState(); // 每次添加标签后更新头像
            }
        }

        // 【新增功能】智能头像切换引擎
        function updateAvatarState() {
            const avatarImg = document.getElementById('avatar');
            const tagsString = portraitTags.join(',').toLowerCase();
            
            // 性别关键词词库
            const maleKeys = ['男', '先生', '小哥哥', '学长', '大叔', '弟弟', '兄'];
            const femaleKeys = ['女', '女士', '小姐姐', '学姐', '阿姨', '妹妹', '姐', '少女'];

            let gender = 'unknown';
            if (maleKeys.some(k => tagsString.includes(k))) gender = 'male';
            else if (femaleKeys.some(k => tagsString.includes(k))) gender = 'female';

            // 根据性别切换不同的风格和 Seed（修复了之前这里的空格 Bug！）
            let newSrc = ''; 
            if (gender === 'male') {
                newSrc = "https://api.dicebear.com/7.x/notionists/svg?seed=Felix&backgroundColor=transparent";
            } else if (gender === 'female') {
                newSrc = "https://api.dicebear.com/7.x/notionists/svg?seed=Kiki&backgroundColor=transparent";
            } else {
                newSrc = "https://api.dicebear.com/7.x/bottts/svg?seed=UnknownRobot&backgroundColor=transparent";
            }

            // 只有当图片源不一样时才更新，防止闪烁
            if (avatarImg.src !== newSrc) {
                avatarImg.style.opacity = 0; // 先渐隐
                setTimeout(() => {
                    avatarImg.src = newSrc;
                    avatarImg.style.opacity = 1; // 加载完渐显
                }, 300);
            }
        }

        function renderTags() {
            const list = document.getElementById('tagList');
            // 修复了之前点击标签的移除交互逻辑
            list.innerHTML = portraitTags.map(t => `<div class="tag-item" onclick="removeTag('${t}')">${t} <span style="cursor:pointer;margin-left:4px;color:#fff;">×</span></div>`).join('');
            const decRate = Math.min(100, portraitTags.length * 15);
            document.getElementById('decDisplay').innerText = decRate + '%';
        }

        // 点击标签删除功能
        function removeTag(tagToRemove) {
            portraitTags = portraitTags.filter(t => t !== tagToRemove);
            localStorage.setItem('lingxi_tags', JSON.stringify(portraitTags));
            renderTags();
            updateAvatarState();
        }

        // --- 核心分析引擎 ---
        async function startAnalysis() {
            const chat = document.getElementById('chatInput').value;
            const goal = document.getElementById('goalSelect').value;
            const output = document.getElementById('output');
            
            if(!chat) return alert(">>> 错误：未检测到对话输入 <<<");

            // 加载时的动画效果
            output.innerHTML = `
                <div style="text-align:center; color:var(--cyan); margin-top:50px;">
                    <div style="margin-bottom:15px; font-size:24px;">⚪ ⚪ ⚪</div>
                    <div style="letter-spacing:2px;">正在接入云端神经网络...</div>
                </div>`;

            const fullPrompt = `你现在是社交分析引擎“罗塞塔”。
            [当前对话]：${chat}
            [用户目标]：${goal}
            [对方画像]：${portraitTags.join(', ')}
            任务：分析对方潜台词，给出好感度变化(-10到10)和两个回复选项。
            必须严格返回JSON格式：{"inference": "...", "aff_change": 5, "options": [{"tag": "方向", "text": "..."}]}`;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: fullPrompt }) 
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const aiText = data.candidates[0].content.parts[0].text;
                const cleanJson = aiText.replace(/```json|```/g, '').trim();
                const result = JSON.parse(cleanJson);
                
                currentAff = Math.min(100, Math.max(0, currentAff + result.aff_change));
                document.getElementById('affDisplay').innerText = currentAff + '%';
                
                // 输出结果，包裹在 result-card 容器中以应用动画
                output.innerHTML = `
                    <div class="result-card">
                        <div class="card">
                            <span class="card-header header-cyan">灵犀·适度推演报告</span>
                            <div class="card-body">${result.inference}</div>
                        </div>
                        <div class="card">
                            <span class="card-header header-pink">罗塞塔·战术建议</span>
                            <div class="card-body">
                                ${result.options.map(opt => `
                                    <div class="option-pill">
                                        <span class="option-tag">PATH // ${opt.tag}</span>
                                        <div class="option-text">${opt.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                output.innerHTML = `<div class="card" style="border-color:var(--pink);">
                    <span class="card-header header-pink">⚠ 系统故障</span>
                    <div class="card-body" style="color:var(--pink);">[错误代码]：${err.message}</div>
                </div>`;
            }
        }
    </script>
</body>
</html>
