<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>灵犀·罗塞塔 v4.0 - 动态侧写</title>
    <style>
        :root { --pink: #ff2d78; --cyan: #00f7ff; --bg-dark: #0a0b12; --glass-bg: rgba(20, 25, 40, 0.6); --glass-border: 1px solid rgba(255, 255, 255, 0.08); --text-primary: #e0e6ff; --text-secondary: #8a94b8; }
        body { margin: 0; background-color: var(--bg-dark); background-image: radial-gradient(circle at 10% 20%, rgba(0, 247, 255, 0.1) 0%, transparent 40%), radial-gradient(circle at 90% 80%, rgba(255, 45, 120, 0.1) 0%, transparent 40%); color: var(--text-primary); font-family: "PingFang SC", "Helvetica Neue", sans-serif; display: flex; height: 100vh; overflow: hidden; }
        .section-label { font-size: 10px; color: var(--cyan); letter-spacing: 2px; margin-bottom: 12px; display: block; text-transform: uppercase; opacity: 0.8; }
        ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        /* 左侧区域 */
        .left-radar { width: 38%; display: flex; flex-direction: column; border-right: 1px solid rgba(255,255,255,0.05); background: linear-gradient(180deg, rgba(10,11,18,0.8) 0%, rgba(0,0,0,0.4) 100%); }
        .avatar-zone { flex: 2; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; gap: 15px; padding: 20px 0; }
        .avatar-zone::after { content: ''; position: absolute; width: 100%; height: 100%; background: radial-gradient(circle, transparent 50%, var(--bg-dark) 100%); z-index: 1; pointer-events: none; }
        .stat-badge { text-align: center; z-index: 2; }
        .stat-cn { font-size: 14px; font-weight: 600; margin-bottom: 2px; letter-spacing: 2px;}
        .stat-en { font-size: 9px; color: var(--text-secondary); letter-spacing: 3px; font-weight: bold;}
        .stat-value { font-size: 28px; font-weight: 800; margin-top: 5px; text-shadow: 0 0 15px currentColor; transition: 0.5s; }
        .stat-top { color: var(--pink); } .stat-bottom { color: var(--cyan); }
        .avatar-image { width: 180px; height: 240px; object-fit: contain; filter: drop-shadow(0 0 20px rgba(0, 247, 255, 0.15)); transition: all 0.5s ease; z-index: 2; }
        
        /* 侧写结论展示区 */
        .profile-summary { z-index: 2; font-size: 11px; color: var(--cyan); text-align: center; max-width: 80%; line-height: 1.5; background: rgba(0,247,255,0.05); padding: 8px 12px; border-radius: 8px; border: 1px dashed rgba(0,247,255,0.2); min-height: 20px;}

        /* 情报录入区 */
        .info-zone { flex: 3; padding: 25px; background: rgba(0,0,0,0.2); border-top: var(--glass-border); display: flex; flex-direction: column; overflow-y: auto; }
        .intel-area { width: 100%; height: 70px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); color: #fff; padding: 12px; font-size: 13px; outline: none; transition: 0.3s; border-radius: 8px; resize: none; box-sizing: border-box;}
        .intel-area:focus { border-color: var(--cyan); background: rgba(255,255,255,0.06); }
        .btn-submit { margin-top: 10px; background: transparent; border: 1px solid var(--text-secondary); color: var(--text-secondary); padding: 8px; border-radius: 6px; font-size: 12px; cursor: pointer; transition: 0.3s; width: 100%;}
        .btn-submit:hover { border-color: var(--cyan); color: var(--cyan); }
        
        /* AI提炼的标签库 */
        .ai-tag-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .ai-tag { background: rgba(0, 247, 255, 0.08); border: 1px solid rgba(0,247,255,0.3); color: var(--cyan); padding: 4px 10px; border-radius: 6px; font-size: 11px; }
        
        /* 原始情报记录 */
        .raw-intel-list { margin-top: 20px; font-size: 11px; color: var(--text-secondary); line-height: 1.6; }
        .raw-intel-item { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); }

        /* 右侧控制台 */
        .right-console { width: 62%; display: flex; flex-direction: column; padding: 30px; overflow-y: auto; }
        .input-box { margin-bottom: 30px; }
        .chat-area { width: 100%; height: 120px; background: rgba(255,255,255,0.03); border: var(--glass-border); color: var(--text-primary); padding: 18px; border-radius: 12px; resize: none; font-size: 15px; line-height: 1.6; box-sizing: border-box; transition: 0.3s; }
        .chat-area:focus { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.2); outline: none; }
        .controls { display: flex; gap: 20px; align-items: center; margin-top: 20px; }
        select { background: var(--glass-bg); border: var(--glass-border); color: var(--text-primary); padding: 12px 20px; border-radius: 8px; outline: none; flex: 1; cursor: pointer; }
        .btn-run { background: transparent; border: 1px solid var(--cyan); color: var(--cyan); padding: 12px 40px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s; }
        .btn-run:hover { background: var(--cyan); color: #000; box-shadow: 0 0 25px rgba(0, 247, 255, 0.4); }

        .output-flow { flex: 1; }
        @keyframes slideUpFade { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .result-card { animation: slideUpFade 0.6s cubic-bezier(0.22, 1, 0.36, 1); }
        .card { background: linear-gradient(145deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .card-header { font-size: 11px; color: var(--text-secondary); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; }
        .card-header::before { content:''; display:inline-block; width:8px; height:8px; background:currentColor; border-radius:50%; margin-right:8px; }
        .header-pink { color: var(--pink); } .header-cyan { color: var(--cyan); }
        .card-body { font-size: 15px; line-height: 1.8; color: #d8e1f0; }
        
        .option-pill { position: relative; background: rgba(255, 45, 120, 0.06); border-left: 3px solid var(--pink); padding: 18px; margin-top: 15px; border-radius: 0 12px 12px 0; transition: 0.3s; }
        .option-pill:hover { background: rgba(255, 45, 120, 0.12); transform: translateX(5px); }
        .option-tag { font-size: 11px; color: var(--pink); font-weight: 700; margin-bottom: 8px; display: block; letter-spacing: 1px; }
        .option-text { font-size: 15px; }
        .btn-copy { position: absolute; right: 15px; top: 15px; background: transparent; border: 1px solid rgba(255, 45, 120, 0.4); color: var(--pink); padding: 4px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .btn-copy:hover { background: var(--pink); color: #fff; }

        @media (max-width: 768px) { body { flex-direction: column; overflow-y: auto; height: auto; } .left-radar, .right-console { width: 100%; } .left-radar { height: auto; border-right: none; border-bottom: 1px solid rgba(255,255,255,0.1); } .avatar-zone { padding: 30px 0; } .right-console { padding: 25px; } }
    </style>
</head>
<body>

    <div class="left-radar">
        <div class="avatar-zone">
            <div class="stat-badge stat-top">
                <div class="stat-cn">好感度</div>
                <div class="stat-en">AFFECTION RATE</div>
                <div class="stat-value" id="affDisplay">30%</div>
            </div>
            
            <img class="avatar-image" id="avatar" src="https://api.dicebear.com/7.x/bottts/svg?seed=Unknown&backgroundColor=transparent" alt="Avatar">
            
            <div class="profile-summary" id="profileSummary">等待情报输入，系统尚未建立目标心理模型...</div>

            <div class="stat-badge stat-bottom">
                <div class="stat-cn">灵魂解码率</div>
                <div class="stat-en">DECODING LEVEL</div>
                <div class="stat-value" id="decDisplay">0%</div>
            </div>
        </div>

        <div class="info-zone">
            <span class="section-label">Target Intel Drop // 碎片情报投递舱</span>
            <textarea class="intel-area" id="intelInput" placeholder="> 录入任何细节：朋友圈动态、日常相处细节、矛盾行为..."></textarea>
            <button class="btn-submit" onclick="submitIntel()" id="btnSubmitIntel">提交情报并启动AI深度侧写 >></button>
            
            <div class="ai-tag-list" id="aiTagList"></div>
            
            <div style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                <span class="section-label" style="display:flex; justify-content:space-between;">
                    Raw Data // 已归档情报
                    <span style="cursor:pointer; color:var(--pink);" onclick="clearIntel()">[清空档案]</span>
                </span>
                <div class="raw-intel-list" id="rawIntelList"></div>
            </div>
        </div>
    </div>

    <div class="right-console">
        <div class="input-box">
            <span class="section-label">Rosetta Core // 对话破译控制台</span>
            <textarea id="chatInput" class="chat-area" placeholder="> 在此粘贴目标回复记录..."></textarea>
            <div class="controls">
                <select id="goalSelect">
                    <option value="建立舒适感">策略：建立舒适感 (Comfort)</option>
                    <option value="制造张力/暧昧">策略：制造张力 (Tension)</option>
                    <option value="发起线下邀约">策略：发起邀约 (Date invite)</option>
                    <option value="化解冲突/尴尬">策略：化解冲突 (Resolve)</option>
                </select>
                <button class="btn-run" onclick="startAnalysis()">启动罗塞塔破译 >></button>
            </div>
        </div>
        <div class="output-flow" id="output">
            <div style="text-align:center; color: var(--text-secondary); margin-top:80px; letter-spacing: 2px;">
                [ 等待指令输入... ]
            </div>
        </div>
    </div>

    <script>
        // 核心数据结构升级：保存原始情报和AI侧写结果
        let intelHistory = JSON.parse(localStorage.getItem('lingxi_intel')) || [];
        let aiProfile = JSON.parse(localStorage.getItem('lingxi_profile')) || { tags: [], decoding_rate: 0, summary: "等待情报输入，系统尚未建立目标心理模型..." };
        let currentAff = 30;

        window.onload = () => {
            renderIntelUI();
            updateAvatarState();
        };

        // 清空档案
        function clearIntel() {
            if(confirm("确定要清空该目标的所有情报档案吗？")) {
                intelHistory = [];
                aiProfile = { tags: [], decoding_rate: 0, summary: "等待情报输入，系统尚未建立目标心理模型..." };
                localStorage.removeItem('lingxi_intel');
                localStorage.removeItem('lingxi_profile');
                renderIntelUI();
                updateAvatarState();
            }
        }

        // 提交大段情报给AI侧写
        async function submitIntel() {
            const input = document.getElementById('intelInput');
            const text = input.value.trim();
            if (!text) return;

            const btn = document.getElementById('btnSubmitIntel');
            btn.innerText = "正在进行神经网络心理侧写...";
            btn.style.color = "var(--cyan)";
            
            // 营造扫描动画感
            document.getElementById('decDisplay').innerText = "SCAN...";
            document.getElementById('decDisplay').style.color = "var(--cyan)";

            // 存入本地记录
            intelHistory.push(text);
            localStorage.setItem('lingxi_intel', JSON.stringify(intelHistory));
            input.value = '';
            renderIntelUI();

            try {
                // 请求后端进行 profile 分析
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'profile', intel: intelHistory }) 
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const aiText = data.candidates[0].content.parts[0].text;
                const cleanJson = aiText.replace(/```json|```/g, '').trim();
                const result = JSON.parse(cleanJson);
                
                // 更新侧写档案
                aiProfile = result;
                localStorage.setItem('lingxi_profile', JSON.stringify(aiProfile));
                
                renderIntelUI();
                updateAvatarState();
                
            } catch (err) {
                alert("侧写失败：" + err.message);
                document.getElementById('decDisplay').innerText = "ERROR";
            } finally {
                btn.innerText = "提交情报并启动AI深度侧写 >>";
                btn.style.color = "var(--text-secondary)";
                document.getElementById('decDisplay').style.color = "var(--cyan)";
            }
        }

        // 渲染左侧的UI（解码率、标签、历史记录）
        function renderIntelUI() {
            document.getElementById('decDisplay').innerText = aiProfile.decoding_rate + '%';
            document.getElementById('profileSummary').innerText = aiProfile.summary || "等待情报...";
            
            const tagList = document.getElementById('aiTagList');
            tagList.innerHTML = aiProfile.tags.map(t => `<div class="ai-tag">${t}</div>`).join('');
            
            const rawList = document.getElementById('rawIntelList');
            rawList.innerHTML = intelHistory.map(i => `<div class="raw-intel-item">> ${i}</div>`).join('');
        }

        // 智能头像依然工作，但根据AI推演的tags来识别
        function updateAvatarState() {
            const avatarImg = document.getElementById('avatar');
            const tagsString = aiProfile.tags.join(',').toLowerCase();
            
            const maleKeys = ['男', '先生', '哥哥', '学长', '大叔', '弟弟', '兄', '爹'];
            const femaleKeys = ['女', '女士', '姐姐', '学姐', '阿姨', '妹妹', '姐', '少女', '妹', '妈'];

            let gender = 'unknown';
            if (maleKeys.some(k => tagsString.includes(k))) gender = 'male';
            else if (femaleKeys.some(k => tagsString.includes(k))) gender = 'female';

            let newSrc = ''; 
            if (gender === 'male') {
                newSrc = "https://api.dicebear.com/7.x/notionists/svg?seed=Felix&backgroundColor=transparent";
            } else if (gender === 'female') {
                newSrc = "https://api.dicebear.com/7.x/notionists/svg?seed=Kiki&backgroundColor=transparent";
            } else {
                newSrc = "https://api.dicebear.com/7.x/bottts/svg?seed=UnknownRobot&backgroundColor=transparent";
            }

            if (avatarImg.src !== newSrc) {
                avatarImg.style.opacity = 0; 
                setTimeout(() => {
                    avatarImg.src = newSrc;
                    avatarImg.style.opacity = 1; 
                }, 300);
            }
        }

        function copyText(btn) {
            const textDiv = btn.parentElement.querySelector('.option-text');
            navigator.clipboard.writeText(textDiv.innerText).then(() => {
                const originalText = btn.innerText;
                btn.innerText = '✔ 已复制';
                btn.style.background = 'var(--pink)';
                btn.style.color = '#fff';
                setTimeout(() => { btn.innerText = originalText; btn.style.background = 'transparent'; btn.style.color = 'var(--pink)'; }, 2000);
            });
        }

        // 聊天破译逻辑（现在会带上AI生成的侧写档案发给大模型）
        async function startAnalysis() {
            const chat = document.getElementById('chatInput').value;
            const goal = document.getElementById('goalSelect').value;
            const output = document.getElementById('output');
            
            if(!chat) return alert(">>> 错误：未检测到对话输入 <<<");

            output.innerHTML = `
                <div style="text-align:center; color:var(--cyan); margin-top:50px;">
                    <div style="margin-bottom:15px; font-size:24px;">⚪ ⚪ ⚪</div>
                    <div style="letter-spacing:2px;">正在基于 [${aiProfile.decoding_rate}% 灵魂解码率] 进行破译...</div>
                </div>`;

            // 【关键】：把AI的侧写结果传给聊天分析引擎
            const fullPrompt = `你现在是顶尖的社交军师“罗塞塔”。
            [目标深度侧写档案]：${aiProfile.summary} | 核心标签：${aiProfile.tags.join(',')}
            [当前对话]：${chat}
            [我方战术目标]：${goal}
            
            请严格按JSON格式返回分析结果：
            {"inference": "简明扼要的潜台词分析...", "aff_change": 5, "options": [{"tag": "战术思路", "text": "回复内容"}]}

            【语气要求】：绝对禁止AI味！严禁括号加动作！回复必须像现代年轻人在微信聊天，简短、自然、口语化。根据侧写档案中对方的性格，调整回复的松弛度和态度。`;

            try {
                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type: 'chat', prompt: fullPrompt }) 
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                const aiText = data.candidates[0].content.parts[0].text;
                const cleanJson = aiText.replace(/```json|```/g, '').trim();
                const result = JSON.parse(cleanJson);
                
                currentAff = Math.min(100, Math.max(0, currentAff + result.aff_change));
                document.getElementById('affDisplay').innerText = currentAff + '%';
                
                output.innerHTML = `
                    <div class="result-card">
                        <div class="card">
                            <span class="card-header header-cyan">灵犀·适度推演报告</span>
                            <div class="card-body">${result.inference}</div>
                        </div>
                        <div class="card">
                            <span class="card-header header-pink">罗塞塔·战术建议</span>
                            <div class="card-body">
                                ${result.options.map(opt => `
                                    <div class="option-pill">
                                        <button class="btn-copy" onclick="copyText(this)">复制文本</button>
                                        <span class="option-tag">PATH // ${opt.tag}</span>
                                        <div class="option-text">${opt.text}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                output.innerHTML = `<div class="card" style="border-color:var(--pink);">
                    <span class="card-header header-pink">⚠ 系统故障</span>
                    <div class="card-body" style="color:var(--pink);">[错误代码]：${err.message}</div>
                </div>`;
            }
        }
    </script>
</body>
</html>
